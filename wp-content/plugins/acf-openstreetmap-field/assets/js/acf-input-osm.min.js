!function(c,e,t){function a(e,t){return function(){return parseFloat(this.attributes[e])}}function i(e,t){return function(e){return parseFloat(parseFloat(e).toFixed(t))}}var r,n=e.options,o=e.i18n,s=t.osm={},l=Backbone.Model.extend({get:function(e){return _.isFunction(this.getters[e])?this.getters[e].call(this):Backbone.Model.prototype.get.call(this,e)},set:function(e,t,a){var i,r;for(r in _.isObject(e)||null==e?(i=e,a=t):(i={})[e]=t,a=a||{},i)_.isFunction(this.setters[r])&&(i[r]=this.setters[r].call(this,i[r],a));return Backbone.Model.prototype.set.call(this,i,a)},getters:{},setters:{}});s.MarkerData=l.extend({getters:{lat:a("lat",n.accuracy),lng:a("lng",n.accuracy)},setters:{lat:i(0,n.accuracy),lng:i(0,n.accuracy)},isDefaultLabel:function(){return this.get("label")===this.get("default_label")}}),s.MarkerCollection=Backbone.Collection.extend({model:s.MarkerData}),s.MapData=l.extend({getters:{lat:a("lat",n.accuracy),lng:a("lng",n.accuracy),zoom:(r="zoom",function(){return parseInt(this.attributes[r])})},setters:{lat:i(0,n.accuracy),lng:i(0,n.accuracy),zoom:function(e){return parseInt(e)}},initialize:function(e){this.set("markers",new s.MarkerCollection(e.markers)),l.prototype.initialize.apply(this,arguments)}}),s.MarkerEntry=wp.Backbone.View.extend({tagName:"div",className:"osm-marker",template:wp.template("osm-marker-input"),events:{'click [data-name="locate-marker"]':"locate_marker",'click [data-name="remove-marker"]':"remove_marker",'change [data-name="label"]':"update_marker_label"},initialize:function(e){return wp.media.View.prototype.initialize.apply(this,arguments),this.marker=e.marker,(this.marker.osm_controller=this).model=e.model,this.listenTo(this.model,"change:label",this.changedLabel),this.listenTo(this.model,"change:default_label",this.changedDefaultLabel),this.listenTo(this.model,"change:lat",this.changedlatLng),this.listenTo(this.model,"change:lng",this.changedlatLng),this.listenTo(this.model,"destroy",this.remove),this.render()},changedLabel:function(){var e=this.model.get("label");this.$('[data-name="label"]').val(e).trigger("change"),this.marker.unbindTooltip(),this.marker.bindTooltip(e),this.marker.options.title=e,c(this.marker._icon).attr("title",e)},changedDefaultLabel:function(){this.model.get("label")===this.model.previous("default_label")&&this.model.set("label",this.model.get("default_label"))},changedlatLng:function(){this.marker.setLatLng({lat:this.model.get("lat"),lng:this.model.get("lng")})},render:function(){wp.media.View.prototype.render.apply(this,arguments);var t=this;return this.$el.find('[data-name="label"]').on("focus",function(e){t.hilite_marker()}).on("blur",function(e){t.lolite_marker()}).val(this.model.get("label")).trigger("change"),c(this.marker._icon).on("focus",function(e){t.hilite_marker()}).on("blur",function(e){t.lolite_marker()}),this},update_marker_label:function(e){var t=c(e.target).val();return""===t&&(t=this.model.get("default_label")),this.model.set("label",t),this},update_marker_geocode:function(e){return this.model.isDefaultLabel()&&this.set_marker_label(e),this.$el.find('[id$="-marker-geocode"]').val(e).trigger("change"),this._update_values_from_marker(),this},_update_values_from_marker:function(){var e=this.marker.getLatLng();return this.model.set("lat",e.lat),this.model.set("lng",e.lng),this.model.set("label",this.marker.options.title),this},hilite_marker:function(e){this.$el.addClass("focus"),c(this.marker._icon).addClass("focus")},lolite_marker:function(e){this.$el.removeClass("focus"),c(this.marker._icon).removeClass("focus")},locate_marker:function(){return this.marker._map.flyTo(this.marker.getLatLng()),this},remove_marker:function(e){return e.preventDefault(),this.model.destroy(),this}}),s.Field=Backbone.View.extend({map:null,field:null,geocoder:null,visible:null,$parent:function(){return this.$el.closest(".acf-field-settings,.acf-field-open-street-map")},$value:function(){return this.$parent().find("input.osm-json")},$results:function(){return this.$parent().find(".osm-results")},$markers:function(){return this.$parent().find(".osm-markers")},preventDefault:function(e){e.preventDefault()},initialize:function(e){var t=this,a=this.getMapData();return this.config=this.$el.data().editorConfig,this.map=e.map,this.field=e.field,this.model=new s.MapData(a),this.init_acf(),this.config.allow_providers&&(this.$el.on("acf-osm-map-create-layers",this.preventDefault),this.initLayers()),this.$el.on("acf-osm-map-create-markers",this.preventDefault),this.initMarkers(),this.listenTo(this.model,"change",this.updateValue),this.listenTo(this.model.get("markers"),"add",this.addMarker),this.listenTo(this.model.get("markers"),"add",this.updateValue),this.listenTo(this.model.get("markers"),"remove",this.updateValue),this.listenTo(this.model.get("markers"),"change",this.updateValue),this.map.on("zoomend",function(){t.model.set("zoom",t.map.getZoom())}),this.map.on("moveend",function(){var e=t.map.getCenter();t.model.set("lat",e.lat),t.model.set("lng",e.lng)}),this.update_visible(),this.update_map(),acf.addAction("remount_field/type=open_street_map",function(e){t.field===e&&t.map.invalidateSize()}),this},getMapData:function(){var e=JSON.parse(this.$value().val());return e.lat=e.lat||this.$el.attr("data-map-lat"),e.lng=e.lng||this.$el.attr("data-map-lng"),e.zoom=e.zoom||this.$el.attr("data-map-zoom"),e},updateValue:function(){this.$value().val(JSON.stringify(this.model.toJSON())).trigger("change"),this.updateMarkerState()},updateMarkerState:function(){var e=this.model.get("markers").length;this.$el.attr("data-has-markers",e?"true":"false"),this.$el.attr("data-can-add-marker",!1===this.config.max_markers||e<this.config.max_markers?"true":"false")},addMarker:function(a,e){var i=this,t=L.marker({lat:a.get("lat"),lng:a.get("lng")},{title:a.get("label"),icon:this.icon}).bindTooltip(a.get("label")),r=new s.MarkerEntry({controller:this,marker:t,model:a});this.map.once("layeradd",function(e){t.on("click",function(e){a.destroy()}).on("dragend",function(e){var t=this.getLatLng();a.set("lat",t.lat),a.set("lng",t.lng),i.reverseGeocode(a)}).dragging.enable(),r.$el.appendTo(i.$markers())}),a.on("destroy",function(){t.remove()}),t.addTo(this.map)},initMarkers:function(){var r=this;this.initGeocode(),this.$el.attr("data-has-markers","false"),this.$el.attr("data-can-add-marker","false"),0!==this.config.max_markers&&(this.model.get("markers").length,this.icon=new L.DivIcon({html:"",className:"osm-marker-icon"}),this.model.get("markers").forEach(function(e){r.addMarker(e)}),this.map.on("dblclick",function(e){var t,a=e.latlng,i=r.model.get("markers");e.originalEvent.preventDefault(),e.originalEvent.stopPropagation(),!1!==r.config.max_markers&&i.length>=r.config.max_markers||(t=new s.MarkerData({label:"",default_label:"",lat:a.lat,lng:a.lng}),i.add(t),r.reverseGeocode(t))}).doubleClickZoom.disable(),this.updateMarkerState())},initGeocode:function(){var n=this,e=this.$el.prev();e.is(".acf-osm-above")?e.html(""):e=c('<div class="acf-osm-above"></div>').insertBefore(this.$el),this.map._controlCorners.above=e.get(0),this.geocoder=L.Control.geocoder({collapsed:!1,position:"above",placeholder:o.search,errorMessage:o.nothing_found,showResultIcons:!0,suggestMinLength:3,suggestTimeout:250,queryMinLength:3,defaultMarkGeocode:!1}).on("markgeocode",function(e){var t=e.geocode.center,a=n.model.get("markers").length,i=n.parseGeocodeResult([e.geocode],t),r={label:i,default_label:i,lat:t.lat,lng:t.lng};if(0===n.config.max_markers)return n.map.fitBounds(e.geocode.bbox);a<n.config.max_markers?n.model.get("markers").add(r):1===n.config.max_markers&&n.model.get("markers").at(0).set(r),n.map.setView(t,n.map.getZoom())}).addTo(this.map)},reverseGeocode:function(t){var a=this,i={lat:t.get("lat"),lng:t.get("lng")};this.geocoder.options.geocoder.reverse(i,a.map.getZoom(),function(e){t.set("default_label",a.parseGeocodeResult(e,i))})},parseGeocodeResult:function(e,t){var a=!1;return e.length?c.each(e,function(e,t){return a=t.html?c("<p>"+t.html+"</p>").text().trim().replace(/(\s+)/g," "):t.name,!1}):a=t.lat+", "+t.lng,a},initLayers:function(){var i=this,r=[],n={},o={},s={},l=function(e,t){var a;if(_.isObject(e))return c.each(e,l);if(!function(e){return null===e||!!i.config.restrict_providers&&-1===i.config.restrict_providers.indexOf(e)}(t)){if(s[t])a=s[t],i.map.addLayer(a);else{try{a=L.tileLayer.provider(t)}catch(e){return}a.providerKey=t}i.layer_is_overlay(t,a)?o[t]=a:n[t]=a,-1!==r.indexOf(t)&&i.map.addLayer(a)}};r=this.model.get("layers"),!1!==this.config.restrict_providers&&_.isArray(this.config.restrict_providers)&&(r=r.filter(function(e){return-1!==i.config.restrict_providers.indexOf(e)})),r.length||(r=this.config.restrict_providers.slice(0,1)),this.map.on("baselayerchange layeradd layerremove",function(e){if(e.layer.providerKey){var t=[];i.map.eachLayer(function(e){e.providerKey&&(i.layer_is_overlay(e.providerKey,e)?t.push(e.providerKey):t.unshift(e.providerKey))}),i.model.set("layers",t)}}),c.each(this.config.restrict_providers,l),this.layersControl=L.control.layers(n,o,{collapsed:!0,hideSingleBase:!0}).addTo(this.map)},layer_is_overlay:function(e,t){var a;return!!(t.options.opacity&&t.options.opacity<1)||(a=["^(OpenWeatherMap|OpenSeaMap)","OpenMapSurfer.AdminBounds","Stamen.Toner(Hybrid|Lines|Labels)","Acetate.(foreground|labels|roads)","HillShading","Hydda.RoadsAndLabels","^JusticeMap","OpenInfraMap.(Power|Telecom|Petroleum|Water)","OpenPtMap","OpenRailwayMap","OpenFireMap","SafeCast","CartoDB.DarkMatterOnlyLabels","CartoDB.PositronOnlyLabels"],null!==e.match("("+a.join("|")+")"))},resetLayers:function(){this.map.eachLayer(function(e){e.constructor===L.TileLayer.Provider&&e.remove()}),this.layersControl&&this.layersControl.remove()},update_visible:function(){return this.visible===this.$el.is(":visible")||(this.visible=this.$el.is(":visible"),this.visible&&this.map.invalidateSize()),this},init_acf:function(){function e(){t.update_visible()}var t=this;acf.addAction("show",e),acf.addAction("hide",e),c(document).on("postbox-toggled",e),c(document).on("click",".widget-top *",e)},update_map:function(){var e={lat:this.model.get("lat"),lng:this.model.get("lng")};this.map.setView(e,this.model.get("zoom"))}}),c(document).on("acf-osm-map-create",function(e){c(e.target).closest('[data-id="acfcloneindex"]').length&&e.preventDefault()}).on("acf-osm-map-init",function(t,a){var e;c(t.target).is("[data-editor-config]")&&(!function e(){if(!c(t.target).is(":visible"))return setTimeout(e,250);a.invalidateSize()}(),e=new s.Field({el:t.target,map:a,field:acf.getField(c(t.target).closest(".acf-field"))}),c(t.target).data("_map_editor",e))}),acf.addAction("append",function(){c.acf_leaflet()}),acf.addAction("show_field",function(e){"open_street_map"===e.type&&e.$el.find("[data-editor-config]").data("_map_editor").update_visible()})}(jQuery,acf_osm_admin,window);